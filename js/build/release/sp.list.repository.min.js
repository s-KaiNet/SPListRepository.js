Type.registerNamespace("SPListRepo");SPListRepo.Helpers=function(){"use strict";return{ensureTrailingSlash:function(a){return a.endsWith("/")?a:a+"/"},ensureLeadingSlash:function(a){return a.startsWith("/")?a:"/"+a}}}(jQuery);!function(){"use strict";window.SPListRepo.isDebug=0}();Type.registerNamespace("SPListRepo.Fields");Type.registerNamespace("SPListRepo.ErrorCodes");!function(a){"use strict";a.ErrorCodes.FolderAlreadyExists=-2130245363;a.ErrorCodes.IllegalName=-2130575245;a.Fields.Modified="Modified";a.Fields.Created="Created";a.Fields.ModifiedBy="Editor";a.Fields.CreatedBy="Author";a.Fields.ID="ID";a.Fields.FSObjType="FSObjType";a.Fields.Title="Title";a.Fields.FileLeafRef="FileLeafRef";a.Fields.FileDirRef="FileDirRef";a.Fields.ContentTypeId="ContentTypeId"}(SPListRepo);SPListRepo.RequestError=function(){"use strict";function a(a){if(a instanceof SP.ClientRequestFailedEventArgs){this.stackTrace=a.get_stackTrace();this.message=a.get_message();this.correlation=a.get_errorTraceCorrelationId();this.errorCode=a.get_errorCode();this.details=a.get_errorDetails();this.errorType=a.get_errorTypeName()}else"string"==typeof a&&(this.message=a)}return a}();SPListRepo.RequestError.registerClass("SPListRepo.RequestError");SPListRepo.ListService=function(a){"use strict";function b(b,c,d){a.ajax({url:b,type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(a){var b=SP.ClientContext.get_current(),d=b.get_web().get_lists().getById(a.d.results[0].Id);b.load(d,"Title","RootFolder","Id");b.executeQueryAsync(function(){c(d)},function(a,b){loadDeferred.reject(new SPListRepo.RequestError(b))})},error:function(a,b){d(b)}})}return{getListByUrl:function(c){var d=a.Deferred(),e=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webAbsoluteUrl),f=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl),g=String.format("{0}_api/web/lists/?$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",e,f,c),h=SP.ClientContext.get_current(),i=function(a){d.resolve(a)},j=function(a){d.reject(new SPListRepo.RequestError(a))};if(h.get_web().getList){var k=h.get_web().getList(String.format("{0}{1}",f,c));h.load(k,"Title","RootFolder","Id");h.executeQueryAsync(function(){i(k)},function(a,b){j(b)})}else b(g,i,j);return d.promise()},getListById:function(b){var c=a.Deferred(),d=SP.ClientContext.get_current(),e=d.get_web().get_lists().getById(b);d.load(e,"Title","RootFolder","Id");d.executeQueryAsync(function(){c.resolve(e)},function(a,b){c.reject(new SPListRepo.RequestError(b))});return c.promise()}}}(jQuery);SPListRepo.ViewScope=function(){};SPListRepo.ViewScope.prototype={FilesOnly:0,FoldersOnly:1,FilesFolders:2,FilesOnlyRecursive:3,FoldersOnlyRecursive:4,FilesFoldersRecursive:5};SPListRepo.ViewScope.registerEnum("SPListRepo.ViewScope",!1);SPListRepo.QuerySettings=function(){"use strict";function a(a,b,c){var d=Function.validateParameters(arguments,[{name:"viewScope",type:SPListRepo.ViewScope,optional:!0},{name:"viewFields",type:Array,elementType:String,optional:!0,mayBeNull:!0},{name:"rowLimit",type:Number,optional:!0}],!0);if(d)throw d;this.viewScope=a;this.viewFields=b;this.rowLimit=c}return a}();SPListRepo.QuerySettings.registerClass("SPListRepo.QuerySettings");SPListRepo.BaseListItem=function(){"use strict";function a(a){var b=Function.validateParameters(arguments,[{name:"item",type:SP.ListItem,optional:!0}],!0);if(b)throw b;if(a){this.item=a;this.file=this.item.file;this.id=a.get_id();this.created=this.getFieldValue(SPListRepo.Fields.Created);this.createdBy=this.getFieldValue(SPListRepo.Fields.CreatedBy);this.modified=this.getFieldValue(SPListRepo.Fields.Modified);this.modifiedBy=this.getFieldValue(SPListRepo.Fields.ModifiedBy);this.title=this.getFieldValue(SPListRepo.Fields.Title);this.fileDirRef=this.getFieldValue(SPListRepo.Fields.FileDirRef);this.fileSystemObjectType=this.item.get_fileSystemObjectType()}}a.prototype.getFieldValue=function(a){var b=this.item.get_fieldValues()[a];return"undefined"!=typeof b?this.item.get_item(a):void 0};return a}();SPListRepo.BaseListItem.registerClass("SPListRepo.BaseListItem");SPListRepo.ListRepository=function(a){"use strict";function b(a,b){var c=Function.validateParameters(arguments,[{name:"listUrlOrId",type:String},{name:"listItemConstructor",type:Function}],!0);if(c)throw c;var d,e,f=/[\da-zA-Z]{8}-([\da-zA-Z]{4}-){3}[\da-zA-Z]{12}/g;a instanceof SP.Guid?d=a.toString():f.test(a)?d=a.match(f)[0]:e=a;this._listItemConstructor=b;this._context=SP.ClientContext.get_current();this._loadListDeferred=d?SPListRepo.ListService.getListById(d):SPListRepo.ListService.getListByUrl(e);this._loadListDeferred.done(Function.createDelegate(this,function(a){this._list=a;var b=a.get_rootFolder().get_serverRelativeUrl();this._listUrl=b.replace(SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl),"")}));this.folder=null}b.prototype={getItems:function(a){var b=Function.validateParameters(arguments,[{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}],!0);if(b)throw b;return this._getItemsByExpression(null,a)},getItemById:function(a){var b=Function.validateParameters(arguments,[{name:"id",type:Number}],!0);if(b)throw b;return this._withPromise(function(b){var c=this._list.getItemById(a);this._context.load(c);var d=this;this._context.executeQueryAsync(function(){var a=new d._listItemConstructor(c);b.resolve(a)},function(a,c){b.reject(new SPListRepo.RequestError(c))})})},getItemsByIds:function(a,b){var c=Function.validateParameters(arguments,[{name:"ids",type:Array,elementType:Number},{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(c)throw c;var d=CamlBuilder.Expression().CounterField(SPListRepo.Fields.ID).In(a);return this._getItemsByExpression(d,b)},getItemsInsideFolders:function(a,b){var c=Function.validateParameters(arguments,[{name:"folderNames",type:Array,elementType:String},{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(c)throw c;var d=this,e=CamlBuilder.Expression().TextField(SPListRepo.Fields.FileDirRef).In(a.map(function(a){var b=d._getFolderRelativeUrl(a);b.startsWith("/")&&(b=b.substring(1));return b}));return this._getItemsByExpression(e,b)},getLastAddedItem:function(a){var b=Function.validateParameters(arguments,[{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(b)throw b;var c=CamlBuilder.Expression().CounterField(SPListRepo.Fields.ID).NotEqualTo(0);a=a||new SPListRepo.QuerySettings(SPListRepo.ViewScope.FilesFolders);a.rowLimit=1;var d=this._getSPCamlQuery(this._getViewQuery(c,a).OrderByDesc(SPListRepo.Fields.ID));return this._getItemsBySPCamlQuery(d)},getLastModifiedItem:function(a){var b=Function.validateParameters(arguments,[{name:"querySettings",type:SPListRepo.QuerySettings,optional:!0}]);if(b)throw b;var c=CamlBuilder.Expression().CounterField(SPListRepo.Fields.ID).NotEqualTo(0);a=a||new SPListRepo.QuerySettings(SPListRepo.ViewScope.FilesFolders);a.rowLimit=1;var d=this._getSPCamlQuery(this._getViewQuery(c,a).OrderByDesc(SPListRepo.Fields.Modified));return this._getItemsBySPCamlQuery(d)},saveItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;return!a.id||a.id<1?this._addItem(a):this._updateItem(a)},deleteItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;return this._withPromise(function(b){var c=this._list.getItemById(a.id);this._context.load(c);c.deleteObject();this._context.executeQueryAsync(function(){b.resolve()},function(a,c){b.reject(new SPListRepo.RequestError(c))})})},createFolder:function(a){var b=Function.validateParameters(arguments,[{name:"folderName",type:String}],!0);if(b)throw b;return this._withPromise(function(b){var c=new SP.ListItemCreationInformation;c.set_underlyingObjectType(SP.FileSystemObjectType.folder);c.set_leafName(a);var d=this._list.addItem(c);d.set_item("Title",a);d.update();this._context.load(d);this._context.executeQueryAsync(function(){b.resolve(d)},function(a,c){b.reject(new SPListRepo.RequestError(c))})})},createFile:function(a,b,c){var d=Function.validateParameters(arguments,[{name:"url",type:String},{name:"content",type:String},{name:"overwrite",type:Boolean}],!0);if(d)throw d;return this._withPromise(function(d){var e=new SP.FileCreationInformation;e.set_url(a);e.set_overwrite(c);e.set_content(new SP.Base64EncodedByteArray);for(var f=0;f<b.length;f++)e.get_content().append(b.charCodeAt(f));var g=this._context.get_web().getFolderByServerRelativeUrl(this._getFolderRelativeUrl()).get_files().add(e);this._context.load(g);this._context.executeQueryAsync(function(){d.resolve(g)},function(a,b){d.reject(new SPListRepo.RequestError(b))})})},_createDeferred:function(){return a.Deferred()},_withPromise:function(a){var b=this._createDeferred();this._loadListDeferred.done(Function.createDelegate(this,function(){a.apply(this,[b])}));return b.promise()},_addItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;return this._withPromise(function(b){var c=new SP.ListItemCreationInformation;this.folder&&c.set_folderUrl(this._getFolderRelativeUrl());var d=this._list.addItem(c);this._setFieldValues(d,a);var e=this;d.update();this._context.load(d);this._context.executeQueryAsync(function(){var a=new e._listItemConstructor(d);b.resolve(a)},function(a,c){b.reject(new SPListRepo.RequestError(c))})})},_updateItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;return this._withPromise(function(b){var c=this._list.getItemById(a.id);this._context.load(c);this._setFieldValues(c,a);var d=this;c.update();this._context.executeQueryAsync(function(){var a=new d._listItemConstructor(c);b.resolve(a)},function(a,c){b.reject(new SPListRepo.RequestError(c))})})},_setFieldValues:function(a,b){a.set_item(SPListRepo.Fields.Title,b.title);b.fileLeafRef&&a.set_item(SPListRepo.Fields.FileLeafRef,b.fileLeafRef)},_getFolderRelativeUrl:function(a){var b=a||this.folder,c=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl);return String.format("{0}{1}/{2}",c,this._listUrl,b)},_getItemsByExpression:function(a,b){this._createDeferred();b=b||new SPListRepo.QuerySettings(SPListRepo.ViewScope.FilesFolders);var c=this._getSPCamlQuery(this._getViewQuery(a,b));return this._getItemsBySPCamlQuery(c)},_getItemsBySPCamlQuery:function(a){return this._withPromise(function(b){this.folder&&a.set_folderServerRelativeUrl(this._getFolderRelativeUrl());var c=this._list.getItems(a);this._context.load(c);var d=this;this._context.executeQueryAsync(function(){for(var a=c.getEnumerator(),e=[];a.moveNext();)e.push(new d._listItemConstructor(a.get_current()));b.resolve(e)},function(a,c){b.reject(new SPListRepo.RequestError(c))})})},_getItemByExpression:function(a,b){var c=this._createDeferred();this._getItemsByExpression(a,b).done(function(a){if(a.length>1)throw"Result contains more than one element";c.resolve(1===a.length?a[0]:null)}).fail(function(a){c.reject(a)});return c.promise()},_getViewQuery:function(a,b){var c,d=(this._createDeferred(),(new CamlBuilder).View(b.viewFields));b.rowLimit&&(d=d.RowLimit(b.rowLimit));var e=CamlBuilder.Expression().IntegerField(SPListRepo.Fields.FSObjType).EqualTo(1);switch(b.viewScope){case SPListRepo.ViewScope.FilesOnly:d=d.Scope(CamlBuilder.ViewScope.FilesOnly);break;case SPListRepo.ViewScope.FoldersOnly:case SPListRepo.ViewScope.FilesFolders:break;case SPListRepo.ViewScope.FilesOnlyRecursive:d=d.Scope(CamlBuilder.ViewScope.Recursive);break;case SPListRepo.ViewScope.FoldersOnlyRecursive:case SPListRepo.ViewScope.FilesFoldersRecursive:d=d.Scope(CamlBuilder.ViewScope.RecursiveAll);break;default:d=d.Scope(CamlBuilder.ViewScope.RecursiveAll)}c=b.viewScope===SPListRepo.ViewScope.FoldersOnly||b.viewScope===SPListRepo.ViewScope.FoldersOnlyRecursive?a?d.Query().Where().All(a,e):d.Query().Where().All(e):a?d.Query().Where().All(a):d.Query().Where().All();return c},_getSPCamlQuery:function(a){var b=a.ToString(),c=new SP.CamlQuery;c.set_viewXml(b);return c}};return b}(jQuery);SPListRepo.ListRepository.registerClass("SPListRepo.ListRepository");