Type.registerNamespace("SPListRepo"),SPListRepo.Helpers=function(){"use strict";return{ensureTrailingSlash:function(a){return a.endsWith("/")?a:a+"/"},ensureLeadingSlash:function(a){return a.startsWith("/")?a:"/"+a}}}(jQuery),Type.registerNamespace("SPListRepo.Fields"),Type.registerNamespace("SPListRepo.ErrorCodes"),function(a){"use strict";a.ErrorCodes.FolderAlreadyExists=-2130245363,a.ErrorCodes.IllegalName=-2130575245,a.Fields.Modified="Modified",a.Fields.Created="Created",a.Fields.ModifiedBy="Editor",a.Fields.CreatedBy="Author",a.Fields.ID="ID",a.Fields.FSObjType="FSObjType",a.Fields.Title="Title",a.Fields.FileLeafRef="FileLeafRef",a.Fields.FileDirRef="FileDirRef",a.Fields.ContentTypeId="ContentTypeId"}(SPListRepo),SPListRepo.RequestError=function(){"use strict";function a(a){a instanceof SP.ClientRequestFailedEventArgs?(this.stackTrace=a.get_stackTrace(),this.message=a.get_message(),this.correlation=a.get_errorTraceCorrelationId(),this.errorCode=a.get_errorCode(),this.details=a.get_errorDetails(),this.errorType=a.get_errorTypeName()):"string"==typeof a&&(this.message=a)}return a}(),SPListRepo.RequestError.registerClass("SPListRepo.RequestError"),SPListRepo.ListService=function(a){"use strict";var b={};return{getListByUrl:function(c){if(b[c])return b[c];var d=a.Deferred();b[c]=d;var e=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webAbsoluteUrl),f=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl),g=String.format("{0}_api/web/lists/?$expand=RootFolder&$filter=RootFolder/ServerRelativeUrl eq '{1}{2}'&$select=ID",e,f,c);return console.log(g),a.ajax({url:g,type:"GET",contentType:"application/json;odata=verbose",headers:{Accept:"application/json;odata=verbose"},success:function(a){var e=SP.ClientContext.get_current(),f=e.get_web().get_lists().getById(a.d.results[0].Id);e.load(f),e.executeQueryAsync(function(){b[c]=f,d.resolve(f)},function(a,b){d.reject(new SPListRepo.RequestError(b))})},error:function(a,b){d.reject(new SPListRepo.RequestError(b))}}),d.promise()}}}(jQuery),SPListRepo.ViewScope=function(){},SPListRepo.ViewScope.prototype={FilesOnly:0,FoldersOnly:1,FilesFolders:2,FilesOnlyRecursive:3,FoldersOnlyRecursive:4,FilesFoldersRecursive:5},SPListRepo.ViewScope.registerEnum("SPListRepo.ViewScope",!1),SPListRepo.BaseListItem=function(){"use strict";function a(a){var b=Function.validateParameters(arguments,[{name:"item",type:SP.ListItem}],!0);if(b)throw b;this.item=a,this.id=a.get_id(),this.created=a.get_item(SPListRepo.Fields.Created),this.createdBy=a.get_item(SPListRepo.Fields.CreatedBy),this.modified=a.get_item(SPListRepo.Fields.Modified),this.modifiedBy=a.get_item(SPListRepo.Fields.ModifiedBy),this.title=a.get_item(SPListRepo.Fields.Title),this.fileDirRef=a.get_item(SPListRepo.Fields.FileDirRef)}return a}(),SPListRepo.BaseListItem.registerClass("SPListRepo.BaseListItem"),SPListRepo.ListRepository=function(a){"use strict";function b(a,b){var c=Function.validateParameters(arguments,[{name:"listUrl",type:String},{name:"listItemConstructor",type:Function}],!0);if(c)throw c;this._listUrl=a,this._listItemConstructor=b,this._context=SP.ClientContext.get_current(),this._loadListDeffered=SPListRepo.ListService.getListByUrl(this._listUrl),this._loadListDeffered.done(Function.createDelegate(this,function(a){this._list=a})),this.folder=null}return b.prototype={getItems:function(a){var b=Function.validateParameters(arguments,[{name:"viewScope",type:SPListRepo.ViewScope,optional:!0}],!0);if(b)throw b;var c=new CamlBuilder;switch(a){case SPListRepo.ViewScope.FilesOnly:c=c.View().Scope(CamlBuilder.ViewScope.FilesOnly);break;case SPListRepo.ViewScope.FoldersOnly:c=c.View().Query().Where().IntegerField(SPListRepo.Fields.FSObjType).EqualTo(1);break;case SPListRepo.ViewScope.FilesFolders:c=c.View();break;case SPListRepo.ViewScope.FilesOnlyRecursive:c=c.View().Scope(CamlBuilder.ViewScope.Recursive);break;case SPListRepo.ViewScope.FoldersOnlyRecursive:c=c.View().Scope(CamlBuilder.ViewScope.RecursiveAll).Query().Where().IntegerField(SPListRepo.Fields.FSObjType).EqualTo(1);break;case SPListRepo.ViewScope.FilesFoldersRecursive:c=c.View().Scope(CamlBuilder.ViewScope.RecursiveAll);break;default:c=c.View().Scope(CamlBuilder.ViewScope.RecursiveAll)}var d=new SP.CamlQuery;return d.set_viewXml(String.format('<View Scope="{0}"><Query></Query></View>',viewScopeString)),this._getItemsByQuery(d)},getItemById:function(a){var b=Function.validateParameters(arguments,[{name:"id",type:Number}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=this._list.getItemById(a);this._context.load(b);var d=this;this._context.executeQueryAsync(function(){var a=new d._listItemConstructor(b);c.resolve(a)},function(a,b){c.reject(new RequestError(b))})})),c.promise()},getItemsByIds:function(a){var b=Function.validateParameters(arguments,[{name:"ids",type:Array,elementType:Number}]);if(b)throw b;var c=new CamlBuilder,d=c.Where().CounterField(SPListRepo.Fields.ID).In(a).ToString(),e=new SP.CamlQuery;return e.set_viewXml(String.format("<View><Query>{0}</Query></View>",d)),this._getItemsByQuery(e)},getItemsInsideFolders:function(a){var b=Function.validateParameters(arguments,[{name:"folderNames",type:Array,elementType:String}]);if(b)throw b;var c=this,d=new CamlBuilder,e=d.Where().TextField(SPListRepo.Fields.FileDirRef).In(a.map(function(a){var b=c._getFolderRelativeUrl(a);return b.startsWith("/")&&(b=b.substring(1)),b})).ToString(),f=new SP.CamlQuery;return f.set_viewXml(String.format('<View Scope="RecursiveAll"><Query>{0}</Query></View>',e)),this._getItemsByQuery(f)},getLastAddedItem:function(){var a=new CamlBuilder,b=a.Where().CounterField(SPListRepo.Fields.ID).NotEqualTo(0).OrderByDesc(SPListRepo.Fields.ID).ToString(),c=new SP.CamlQuery;return console.log(c),c.set_viewXml(String.format("<View><Query>{0}</Query></View>",b)),this._getItemByQuery(c)},getFolders:function(){var a=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=new CamlBuilder,c=b.Where().IntegerField(SPListRepo.Fields.FSObjType).EqualTo(1).ToString(),d=new SP.CamlQuery;d.set_viewXml(String.format("<View><Query>{0}</Query></View>",c));var e=this._list.getItems(d),f=this;this._context.load(e),this._context.executeQueryAsync(function(){for(var b=[],c=e.getEnumerator();c.moveNext();){var d=c.get_current();"Item"!==d.get_item(SPListRepo.Fields.Title)&&b.push(new f._listItemConstructor(d))}a.resolve(b)},function(b,c){a.reject(new RequestError(c))})})),a.promise()},saveItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;return!a.id||a.id<1?this._addItem(a):this._updateItem(a)},deleteItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=this._list.getItemById(a.id);this._context.load(b),b.deleteObject(),this._context.executeQueryAsync(function(){c.resolve()},function(a,b){c.reject(new RequestError(b))})})),c.promise()},createFolder:function(a){var b=Function.validateParameters(arguments,[{name:"folderName",type:String}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=new SP.ListItemCreationInformation;b.set_underlyingObjectType(SP.FileSystemObjectType.folder),b.set_leafName(a);var d=this._list.addItem(b);d.set_item("Title",a),d.update(),this._context.load(d),this._context.executeQueryAsync(function(){c.resolve(d)},function(a,b){c.reject(new RequestError(b))})})),c.promise()},_createDeferred:function(){return a.Deferred()},_addItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=new SP.ListItemCreationInformation;this.folder&&b.set_folderUrl(this._getFolderRelativeUrl());var d=this._list.addItem(b);this._setFieldValues(d,a);var e=this;d.update(),this._context.load(d),this._context.executeQueryAsync(function(){var a=new e._listItemConstructor(d);c.resolve(a)},function(a,b){c.reject(new RequestError(b))})})),c.promise()},_updateItem:function(a){var b=Function.validateParameters(arguments,[{name:"model",type:this._listItemConstructor}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){var b=this._list.getItemById(a.id);this._context.load(b),this._setFieldValues(b,a);var d=this;b.update(),this._context.executeQueryAsync(function(){var a=new d._listItemConstructor(b);c.resolve(a)},function(a,b){c.reject(new RequestError(b))})})),c.promise()},_setFieldValues:function(a,b){a.set_item(SPListRepo.Fields.Title,b.title),b.fileLeafRef&&a.set_item(SPListRepo.Fields.FileLeafRef,b.fileLeafRef)},_getFolderRelativeUrl:function(a){var b=a||this.folder,c=SPListRepo.Helpers.ensureTrailingSlash(_spPageContextInfo.webServerRelativeUrl);return String.format("{0}{1}/{2}",c,this._listUrl,b)},_getItemsByQuery:function(a){var b=Function.validateParameters(arguments,[{name:"camlQuery",type:SP.CamlQuery}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){this.folder&&a.set_folderServerRelativeUrl(this._getFolderRelativeUrl());var b=this._list.getItems(a);this._context.load(b);var d=this;this._context.executeQueryAsync(function(){for(var a=b.getEnumerator(),e=[];a.moveNext();)e.push(new d._listItemConstructor(a.get_current()));c.resolve(e)},function(a,b){c.reject(new RequestError(b))})})),c.promise()},_getItemByQuery:function(a){var b=Function.validateParameters(arguments,[{name:"camlQuery",type:SP.CamlQuery}],!0);if(b)throw b;var c=this._createDeferred();return this._loadListDeffered.done(Function.createDelegate(this,function(){this.folder&&a.set_folderServerRelativeUrl(this._getFolderRelativeUrl());var b=this._list.getItems(a);this._context.load(b);var d=this;this._context.executeQueryAsync(function(){for(var a=b.getEnumerator(),e=[];a.moveNext();)e.push(new d._listItemConstructor(a.get_current()));if(e.length>1)throw"Result contains more than one element";c.resolve(1===e.length?e[0]:null)},function(a,b){c.reject(new RequestError(b))})})),c.promise()}},b}(jQuery),SPListRepo.ListRepository.registerClass("SPListRepo.ListRepository");